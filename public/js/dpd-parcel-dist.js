var dpd_parcel_modal,dpd_gmap_api_key=dpd.gmap_api_key,dpd_gmap_base_url="https://maps.googleapis.com/maps/api/geocode/json",dpd_parcel_map={};!function(e){function a(a){a&&a.preventDefault();var o=e('input[name="dpd-modal-address"]').val()+" "+e('input[name="dpd-modal-city"]').val();o&&function(a){if(!dpd_gmap_api_key)return void console.log("Postal code geocoder is missing Google Maps API key");var o=jQuery.param({address:a,type:"street_address",key:dpd_gmap_api_key}),d=dpd_gmap_base_url+"?"+o;e.getJSON(d,(function(e){if("OK"==e.status){var a=function(e){var a;try{a=e.results[0].geometry.location}catch(e){}return a}(e);a?(dpd_parcel_map.my_location=a,dpd_parcel_map.my_marker.setPosition(dpd_parcel_map.my_location),dpd_parcel_map.map.setZoom(15),dpd_parcel_map.map.panTo(dpd_parcel_map.my_location),setTimeout("dpd_parcel_map.map.setZoom(14)",1e3)):console.log("Cannot geocode coordinates from address")}else console.log("Google Maps Geocoder Error",e)}))}(o)}function o(a){a.preventDefault();var o=e(this).data("terminal-code"),d=e(this).data("terminal-title"),p=e(this).data("method"),r=e(this).data("cod");n(!1),e.ajax({url:dpd.wc_ajax_url.toString().replace("%%endpoint%%","choose_dpd_terminal"),dataType:"json",method:"POST",data:{action:"choose_dpd_terminal",terminal_field:p,terminal:o,cod:r,security:dpd.ajax_nonce},success:function(e){console.log("Terminal id: "+e.shipping_parcel_id)},error:function(e,a,o){console.error("DPD Parcel store: "+o)},complete:function(){e(document.body).trigger("update_checkout"),e("#wc_shipping_dpd_parcels_terminal").val(o),e("#dpd-selected-parcel").html(d),e("#dpd-close-parcel-modal").trigger("click"),setTimeout((function(){n(!0)}),1e3)}})}function d(a){var o=a.dpd_terminal;dpd_parcel_map.marker_info=e("#dpd-parcel-modal-info");var d=dpd_parcel_map.marker_info.find("h3"),n=dpd_parcel_map.marker_info.find(".info-address"),p=dpd_parcel_map.marker_info.find(".working-hours-wrapper"),r=dpd_parcel_map.marker_info.find(".mon"),l=dpd_parcel_map.marker_info.find(".tue"),t=dpd_parcel_map.marker_info.find(".wed"),i=dpd_parcel_map.marker_info.find(".thu"),m=dpd_parcel_map.marker_info.find(".fri"),c=dpd_parcel_map.marker_info.find(".sat"),_=dpd_parcel_map.marker_info.find(".sun"),s=dpd_parcel_map.marker_info.find(".info-phone"),f=dpd_parcel_map.marker_info.find(".info-email"),u=dpd_parcel_map.marker_info.find(".select-terminal");if(d.html(o.company),n.html(o.street+", "+o.pcode+", "+o.city||"-"),null==o.mon&&null==o.tue&&null==o.wed&&null==o.thu&&null==o.fri&&null==o.sat&&null==o.sun&&p.hide(),null!=o.mon){var h=o.mon.split("|");r.find(".morning").html(h[0]),r.find(".afternoon").html(h[1])}else r.hide();if(null!=o.tue){var g=o.tue.split("|");l.find(".morning").html(g[0]),l.find(".afternoon").html(g[1])}else l.hide();if(null!=o.wed){var k=o.wed.split("|");t.find(".morning").html(k[0]),t.find(".afternoon").html(k[1])}else t.hide();if(null!=o.thu){var y=o.thu.split("|");i.find(".morning").html(y[0]),i.find(".afternoon").html(y[1])}else i.hide();if(null!=o.fri){var v=o.fri.split("|");m.find(".morning").html(v[0]),m.find(".afternoon").html(v[1])}else m.hide();if(null!=o.sat){var w=o.sat.split("|");c.find(".morning").html(w[0]),c.find(".afternoon").html(w[1])}else c.hide();if(null!=o.sun){var P=o.sun.split("|");_.find(".morning").html(P[0]),_.find(".afternoon").html(P[1])}else _.hide();o.phone?s.html('<a href="tel:'+o.phone+'">'+o.phone+"</a>"):s.html(""),o.email?f.html('<a href="mailto:'+o.email+'">'+o.email+"</a>"):f.html(""),o.phone||o.email||f.html("-"),u.data("terminal-code",o.parcelshop_id),u.data("terminal-title",o.company+", "+o.street),u.attr("data-cod",o.cod),dpd_parcel_map.marker_info.show(),dpd_parcel_map.map.panTo(a.getPosition())}function n(p){p?e(document).ajaxStop((function(){!function(){if(0==(dpd_parcel_modal=e("#dpd-parcel-modal")).length)return;e("body").on("click","#dpd-show-parcel-modal",(function(o){o.preventDefault(),a(null),navigator.geolocation?navigator.geolocation.getCurrentPosition((function(e){dpd_parcel_map.my_location={lat:e.coords.latitude,lng:e.coords.longitude}}),(function(){dpd_parcel_map.my_location={lat:54.8897105,lng:23.9258975}})):dpd_parcel_map.my_location={lat:54.8897105,lng:23.9258975},dpd_parcel_map.markers=[],dpd_parcel_map.marker_info.hide(),dpd_parcel_map.map=new google.maps.Map(document.getElementById("dpd-parcel-modal-map"),{center:dpd_parcel_map.my_location,zoom:15,maxZoom:17,gestureHandling:"greedy",disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER}}),dpd_parcel_map.my_marker=new google.maps.Marker({position:dpd_parcel_map.my_location,map:dpd_parcel_map.map}),n(!1),e.ajax({url:dpd.wc_ajax_url.toString().replace("%%endpoint%%","get_dpd_parcels"),dataType:"json",method:"POST",data:{action:"get_dpd_parcels"},success:function(a){!function(a){if(dpd_parcel_map.markers.length>0){for(var o=0;o<dpd_parcel_map.markers.length;o++)dpd_parcel_map.markers[o].setMap(null);dpd_parcel_map.markers=[]}var n,p;for(o=0;o<a.length;o++){p=a[o];try{(n=new google.maps.Marker({position:{lat:parseFloat(p.latitude),lng:parseFloat(p.longitude)},map:dpd_parcel_map.map,icon:dpd.theme_uri+"point.png"})).dpd_terminal=e.extend({},p),google.maps.event.addListener(n,"click",(function(){this.hasOwnProperty("dpd_terminal")&&d(this)})),dpd_parcel_map.markers.push(n)}catch(e){console.log("Cannot create marker for terminal",p)}}new MarkerClusterer(dpd_parcel_map.map,dpd_parcel_map.markers,{imagePath:dpd.theme_uri+"m",maxZoom:13,minimumClusterSize:1})}(a)},error:function(e,a,o){console.error("DPD Parcel store: "+o)},complete:function(){setTimeout((function(){n(!0)}),1e3)}}),e("#dpd-parcel-modal").css("display","block"),e("body").css("overflow","hidden")})),e("body").on("click","#dpd-close-parcel-modal",(function(a){a.preventDefault(),e("#dpd-parcel-modal").css("display","none"),e("body").css("overflow","auto")})),e("body").on("click","#dpd-parcel-modal",(function(a){a.target==e(this).get(0)&&(e("#dpd-parcel-modal").css("display","none"),e("body").css("overflow","auto"))})),dpd_parcel_map.marker_info=e("#dpd-parcel-modal-info"),e("body").on("click","#dpd-parcel-modal-info .select-terminal",o),dpd_parcel_modal.find(".search-location").off("click").click(a),e(document).on("keyup keypress",'#dpd-parcel-modal input[type="text"]',(function(e){if(13==e.which)return e.preventDefault(),a(),!1}))}()})):e(document).off("ajaxStop")}e(document).ready((function(){n(!0)}))}(jQuery);